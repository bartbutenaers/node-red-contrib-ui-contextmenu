<!--
  Copyright 2019, Bart Butenaers, Stephen McLaughlin
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/javascript">
    function updateEditorLayout(){
        var dlg = $("#dialog-form");
        var height = dlg.height() - 5;
        var expandRow = dlg.find('.form-row-auto-height');
        if(expandRow && expandRow.length){
            let childRows = dlg.find('.form-row:not(.form-row-auto-height)');
            for (var i=0; i<childRows.size(); i++) {
                var cr = $(childRows[i]);
                if(cr.is(":visible"))
                    height -= cr.outerHeight(true);
            }
            let ol = $(expandRow.find(".red-ui-editableList-list"));
            if(ol && ol.length){
                ol.editableList("height",height);
            } else {
                expandRow.css("height",height+"px");
            }
        } 
    }
    RED.nodes.registerType('ui_context_menu',{
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {
                value: 0,
                validate: function(v) {
                    var valid = true
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()|| this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},
            height: {value: -1},
            fontSize: {value: 16},
            position: {value: "fixed"}, // Obsolete field (keep for existing nodes)
            xCoordinate: {value: 50},   // Obsolete field (keep for existing nodes)
            yCoordinate: {value: 50},   // Obsolete field (keep for existing nodes)
            menu: {value: "fixed"},     // Obsolete field (keep for existing nodes)
            inputPositionXField: {value:"event.pageX", validate: function(v) { return !v || v !== ""}},
            inputPositionXType: {value: "msg"},
            inputPositionYField: {value:"event.pageY", validate: function(v) { return !v || v !== ""}},
            inputPositionYType: {value: "msg"},
            outputField: {value: "payload"},
            //unit: {value: "perc"},
            inputMenuField: {value:"menu", validate: function(v) { return !v || v !== ""}},
            inputMenuType: {value: "msg"},
            menuItems: {value: []},
            colors: {value: 'native'},
            // By default we set the same colors as in the ContextMenu library CSS file
            textColor: {value: '#000000'},
            backgroundColor: {value: '#ffffff'},
            borderColor: {value: '#626262'},
            intervalLength: {value: 0},
            intervalUnit: {value: "secs"},
            startTimerAtOpen: {value: false},
            startTimerAtLeave: {value: true},
            stopTimerAtEnter: {value: true},
            name: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "menu.png",
        align: 'left',
        paletteLabel:"Context menu",
        label: function() {
            return this.name || "Context menu";
        },
        oneditprepare: function() {
            var node = this;

            $('#node-input-inputMenuField').val(node.inputMenuField || "menu");
     
            // Migrate older nodes, that didn't have the auto-hide feature yet
            if(node.intervalLength === undefined) {
                $('#node-input-intervalLength').val(0);
            }
            if(node.intervalUnit === undefined) {
                $('#node-input-intervalUnit').val("secs");
            }
            if(node.startTimerAtOpen === undefined) {
                $('#node-input-startTimerAtOpen').prop('checked', false);
            }
            if(node.startTimerAtLeave === undefined) {
                $('#node-input-startTimerAtLeave').prop('checked', true);
            }
            if(node.stopTimerAtEnter === undefined) {
                $('#node-input-stopTimerAtEnter').prop('checked', true);
            }
            
            // List of all available FontAwesome icons (version 4.7.0)
            var iconCssClassNames = [
              "fa-glass",
              "fa-music",
              "fa-search",
              "fa-envelope-o",
              "fa-heart",
              "fa-star",
              "fa-star-o",
              "fa-user",
              "fa-film",
              "fa-th-large",
              "fa-th",
              "fa-th-list",
              "fa-check",
              "fa-remove,before,.fa-close,before,.fa-times",
              "fa-search-plus",
              "fa-search-minus",
              "fa-power-off",
              "fa-signal",
              "fa-gear,before,.fa-cog",
              "fa-trash-o",
              "fa-home",
              "fa-file-o",
              "fa-clock-o",
              "fa-road",
              "fa-download",
              "fa-arrow-circle-o-down",
              "fa-arrow-circle-o-up",
              "fa-inbox",
              "fa-play-circle-o",
              "fa-rotate-right,before,.fa-repeat",
              "fa-refresh",
              "fa-list-alt",
              "fa-lock",
              "fa-flag",
              "fa-headphones",
              "fa-volume-off",
              "fa-volume-down",
              "fa-volume-up",
              "fa-qrcode",
              "fa-barcode",
              "fa-tag",
              "fa-tags",
              "fa-book",
              "fa-bookmark",
              "fa-print",
              "fa-camera",
              "fa-font",
              "fa-bold",
              "fa-italic",
              "fa-text-height",
              "fa-text-width",
              "fa-align-left",
              "fa-align-center",
              "fa-align-right",
              "fa-align-justify",
              "fa-list",
              "fa-dedent,before,.fa-outdent",
              "fa-indent",
              "fa-video-camera",
              "fa-photo,before,.fa-image,before,.fa-picture-o",
              "fa-pencil",
              "fa-map-marker",
              "fa-adjust",
              "fa-tint",
              "fa-edit,before,.fa-pencil-square-o",
              "fa-share-square-o",
              "fa-check-square-o",
              "fa-arrows",
              "fa-step-backward",
              "fa-fast-backward",
              "fa-backward",
              "fa-play",
              "fa-pause",
              "fa-stop",
              "fa-forward",
              "fa-fast-forward",
              "fa-step-forward",
              "fa-eject",
              "fa-chevron-left",
              "fa-chevron-right",
              "fa-plus-circle",
              "fa-minus-circle",
              "fa-times-circle",
              "fa-check-circle",
              "fa-question-circle",
              "fa-info-circle",
              "fa-crosshairs",
              "fa-times-circle-o",
              "fa-check-circle-o",
              "fa-ban",
              "fa-arrow-left",
              "fa-arrow-right",
              "fa-arrow-up",
              "fa-arrow-down",
              "fa-mail-forward,before,.fa-share",
              "fa-expand",
              "fa-compress",
              "fa-plus",
              "fa-minus",
              "fa-asterisk",
              "fa-exclamation-circle",
              "fa-gift",
              "fa-leaf",
              "fa-fire",
              "fa-eye",
              "fa-eye-slash",
              "fa-warning,before,.fa-exclamation-triangle",
              "fa-plane",
              "fa-calendar",
              "fa-random",
              "fa-comment",
              "fa-magnet",
              "fa-chevron-up",
              "fa-chevron-down",
              "fa-retweet",
              "fa-shopping-cart",
              "fa-folder",
              "fa-folder-open",
              "fa-arrows-v",
              "fa-arrows-h",
              "fa-bar-chart-o,before,.fa-bar-chart",
              "fa-twitter-square",
              "fa-facebook-square",
              "fa-camera-retro",
              "fa-key",
              "fa-gears,before,.fa-cogs",
              "fa-comments",
              "fa-thumbs-o-up",
              "fa-thumbs-o-down",
              "fa-star-half",
              "fa-heart-o",
              "fa-sign-out",
              "fa-linkedin-square",
              "fa-thumb-tack",
              "fa-external-link",
              "fa-sign-in",
              "fa-trophy",
              "fa-github-square",
              "fa-upload",
              "fa-lemon-o",
              "fa-phone",
              "fa-square-o",
              "fa-bookmark-o",
              "fa-phone-square",
              "fa-twitter",
              "fa-facebook-f,before,.fa-facebook",
              "fa-github",
              "fa-unlock",
              "fa-credit-card",
              "fa-feed,before,.fa-rss",
              "fa-hdd-o",
              "fa-bullhorn",
              "fa-bell",
              "fa-certificate",
              "fa-hand-o-right",
              "fa-hand-o-left",
              "fa-hand-o-up",
              "fa-hand-o-down",
              "fa-arrow-circle-left",
              "fa-arrow-circle-right",
              "fa-arrow-circle-up",
              "fa-arrow-circle-down",
              "fa-globe",
              "fa-wrench",
              "fa-tasks",
              "fa-filter",
              "fa-briefcase",
              "fa-arrows-alt",
              "fa-group,before,.fa-users",
              "fa-chain,before,.fa-link",
              "fa-cloud",
              "fa-flask",
              "fa-cut,before,.fa-scissors",
              "fa-copy,before,.fa-files-o",
              "fa-paperclip",
              "fa-save,before,.fa-floppy-o",
              "fa-square",
              "fa-navicon,before,.fa-reorder,before,.fa-bars",
              "fa-list-ul",
              "fa-list-ol",
              "fa-strikethrough",
              "fa-underline",
              "fa-table",
              "fa-magic",
              "fa-truck",
              "fa-pinterest",
              "fa-pinterest-square",
              "fa-google-plus-square",
              "fa-google-plus",
              "fa-money",
              "fa-caret-down",
              "fa-caret-up",
              "fa-caret-left",
              "fa-caret-right",
              "fa-columns",
              "fa-unsorted,before,.fa-sort",
              "fa-sort-down,before,.fa-sort-desc",
              "fa-sort-up,before,.fa-sort-asc",
              "fa-envelope",
              "fa-linkedin",
              "fa-rotate-left,before,.fa-undo",
              "fa-legal,before,.fa-gavel",
              "fa-dashboard,before,.fa-tachometer",
              "fa-comment-o",
              "fa-comments-o",
              "fa-flash,before,.fa-bolt",
              "fa-sitemap",
              "fa-umbrella",
              "fa-paste,before,.fa-clipboard",
              "fa-lightbulb-o",
              "fa-exchange",
              "fa-cloud-download",
              "fa-cloud-upload",
              "fa-user-md",
              "fa-stethoscope",
              "fa-suitcase",
              "fa-bell-o",
              "fa-coffee",
              "fa-cutlery",
              "fa-file-text-o",
              "fa-building-o",
              "fa-hospital-o",
              "fa-ambulance",
              "fa-medkit",
              "fa-fighter-jet",
              "fa-beer",
              "fa-h-square",
              "fa-plus-square",
              "fa-angle-double-left",
              "fa-angle-double-right",
              "fa-angle-double-up",
              "fa-angle-double-down",
              "fa-angle-left",
              "fa-angle-right",
              "fa-angle-up",
              "fa-angle-down",
              "fa-desktop",
              "fa-laptop",
              "fa-tablet",
              "fa-mobile-phone,before,.fa-mobile",
              "fa-circle-o",
              "fa-quote-left",
              "fa-quote-right",
              "fa-spinner",
              "fa-circle",
              "fa-mail-reply,before,.fa-reply",
              "fa-github-alt",
              "fa-folder-o",
              "fa-folder-open-o",
              "fa-smile-o",
              "fa-frown-o",
              "fa-meh-o",
              "fa-gamepad",
              "fa-keyboard-o",
              "fa-flag-o",
              "fa-flag-checkered",
              "fa-terminal",
              "fa-code",
              "fa-mail-reply-all,before,.fa-reply-all",
              "fa-star-half-empty,before,.fa-star-half-full,before,.fa-star-half-o",
              "fa-location-arrow",
              "fa-crop",
              "fa-code-fork",
              "fa-unlink,before,.fa-chain-broken",
              "fa-question",
              "fa-info",
              "fa-exclamation",
              "fa-superscript",
              "fa-subscript",
              "fa-eraser",
              "fa-puzzle-piece",
              "fa-microphone",
              "fa-microphone-slash",
              "fa-shield",
              "fa-calendar-o",
              "fa-fire-extinguisher",
              "fa-rocket",
              "fa-maxcdn",
              "fa-chevron-circle-left",
              "fa-chevron-circle-right",
              "fa-chevron-circle-up",
              "fa-chevron-circle-down",
              "fa-html5",
              "fa-css3",
              "fa-anchor",
              "fa-unlock-alt",
              "fa-bullseye",
              "fa-ellipsis-h",
              "fa-ellipsis-v",
              "fa-rss-square",
              "fa-play-circle",
              "fa-ticket",
              "fa-minus-square",
              "fa-minus-square-o",
              "fa-level-up",
              "fa-level-down",
              "fa-check-square",
              "fa-pencil-square",
              "fa-external-link-square",
              "fa-share-square",
              "fa-compass",
              "fa-toggle-down,before,.fa-caret-square-o-down",
              "fa-toggle-up,before,.fa-caret-square-o-up",
              "fa-toggle-right,before,.fa-caret-square-o-right",
              "fa-euro,before,.fa-eur",
              "fa-gbp",
              "fa-dollar,before,.fa-usd",
              "fa-rupee,before,.fa-inr",
              "fa-cny,before,.fa-rmb,before,.fa-yen,before,.fa-jpy",
              "fa-ruble,before,.fa-rouble,before,.fa-rub",
              "fa-won,before,.fa-krw",
              "fa-bitcoin,before,.fa-btc",
              "fa-file",
              "fa-file-text",
              "fa-sort-alpha-asc",
              "fa-sort-alpha-desc",
              "fa-sort-amount-asc",
              "fa-sort-amount-desc",
              "fa-sort-numeric-asc",
              "fa-sort-numeric-desc",
              "fa-thumbs-up",
              "fa-thumbs-down",
              "fa-youtube-square",
              "fa-youtube",
              "fa-xing",
              "fa-xing-square",
              "fa-youtube-play",
              "fa-dropbox",
              "fa-stack-overflow",
              "fa-instagram",
              "fa-flickr",
              "fa-adn",
              "fa-bitbucket",
              "fa-bitbucket-square",
              "fa-tumblr",
              "fa-tumblr-square",
              "fa-long-arrow-down",
              "fa-long-arrow-up",
              "fa-long-arrow-left",
              "fa-long-arrow-right",
              "fa-apple",
              "fa-windows",
              "fa-android",
              "fa-linux",
              "fa-dribbble",
              "fa-skype",
              "fa-foursquare",
              "fa-trello",
              "fa-female",
              "fa-male",
              "fa-gittip,before,.fa-gratipay",
              "fa-sun-o",
              "fa-moon-o",
              "fa-archive",
              "fa-bug",
              "fa-vk",
              "fa-weibo",
              "fa-renren",
              "fa-pagelines",
              "fa-stack-exchange",
              "fa-arrow-circle-o-right",
              "fa-arrow-circle-o-left",
              "fa-toggle-left,before,.fa-caret-square-o-left",
              "fa-dot-circle-o",
              "fa-wheelchair",
              "fa-vimeo-square",
              "fa-turkish-lira,before,.fa-try",
              "fa-plus-square-o",
              "fa-space-shuttle",
              "fa-slack",
              "fa-envelope-square",
              "fa-wordpress",
              "fa-openid",
              "fa-institution,before,.fa-bank,before,.fa-university",
              "fa-mortar-board,before,.fa-graduation-cap",
              "fa-yahoo",
              "fa-google",
              "fa-reddit",
              "fa-reddit-square",
              "fa-stumbleupon-circle",
              "fa-stumbleupon",
              "fa-delicious",
              "fa-digg",
              "fa-pied-piper-pp",
              "fa-pied-piper-alt",
              "fa-drupal",
              "fa-joomla",
              "fa-language",
              "fa-fax",
              "fa-building",
              "fa-child",
              "fa-paw",
              "fa-spoon",
              "fa-cube",
              "fa-cubes",
              "fa-behance",
              "fa-behance-square",
              "fa-steam",
              "fa-steam-square",
              "fa-recycle",
              "fa-automobile,before,.fa-car",
              "fa-cab,before,.fa-taxi",
              "fa-tree",
              "fa-spotify",
              "fa-deviantart",
              "fa-soundcloud",
              "fa-database",
              "fa-file-pdf-o",
              "fa-file-word-o",
              "fa-file-excel-o",
              "fa-file-powerpoint-o",
              "fa-file-photo-o,before,.fa-file-picture-o,before,.fa-file-image-o",
              "fa-file-zip-o,before,.fa-file-archive-o",
              "fa-file-sound-o,before,.fa-file-audio-o",
              "fa-file-movie-o,before,.fa-file-video-o",
              "fa-file-code-o",
              "fa-vine",
              "fa-codepen",
              "fa-jsfiddle",
              "fa-life-bouy,before,.fa-life-buoy,before,.fa-life-saver,before,.fa-support,before,.fa-life-ring",
              "fa-circle-o-notch",
              "fa-ra,before,.fa-resistance,before,.fa-rebel",
              "fa-ge,before,.fa-empire",
              "fa-git-square",
              "fa-git",
              "fa-y-combinator-square,before,.fa-yc-square,before,.fa-hacker-news",
              "fa-tencent-weibo",
              "fa-qq",
              "fa-wechat,before,.fa-weixin",
              "fa-send,before,.fa-paper-plane",
              "fa-send-o,before,.fa-paper-plane-o",
              "fa-history",
              "fa-circle-thin",
              "fa-header",
              "fa-paragraph",
              "fa-sliders",
              "fa-share-alt",
              "fa-share-alt-square",
              "fa-bomb",
              "fa-soccer-ball-o,before,.fa-futbol-o",
              "fa-tty",
              "fa-binoculars",
              "fa-plug",
              "fa-slideshare",
              "fa-twitch",
              "fa-yelp",
              "fa-newspaper-o",
              "fa-wifi",
              "fa-calculator",
              "fa-paypal",
              "fa-google-wallet",
              "fa-cc-visa",
              "fa-cc-mastercard",
              "fa-cc-discover",
              "fa-cc-amex",
              "fa-cc-paypal",
              "fa-cc-stripe",
              "fa-bell-slash",
              "fa-bell-slash-o",
              "fa-trash",
              "fa-copyright",
              "fa-at",
              "fa-eyedropper",
              "fa-paint-brush",
              "fa-birthday-cake",
              "fa-area-chart",
              "fa-pie-chart",
              "fa-line-chart",
              "fa-lastfm",
              "fa-lastfm-square",
              "fa-toggle-off",
              "fa-toggle-on",
              "fa-bicycle",
              "fa-bus",
              "fa-ioxhost",
              "fa-angellist",
              "fa-cc",
              "fa-shekel,before,.fa-sheqel,before,.fa-ils",
              "fa-meanpath",
              "fa-buysellads",
              "fa-connectdevelop",
              "fa-dashcube",
              "fa-forumbee",
              "fa-leanpub",
              "fa-sellsy",
              "fa-shirtsinbulk",
              "fa-simplybuilt",
              "fa-skyatlas",
              "fa-cart-plus",
              "fa-cart-arrow-down",
              "fa-diamond",
              "fa-ship",
              "fa-user-secret",
              "fa-motorcycle",
              "fa-street-view",
              "fa-heartbeat",
              "fa-venus",
              "fa-mars",
              "fa-mercury",
              "fa-intersex,before,.fa-transgender",
              "fa-transgender-alt",
              "fa-venus-double",
              "fa-mars-double",
              "fa-venus-mars",
              "fa-mars-stroke",
              "fa-mars-stroke-v",
              "fa-mars-stroke-h",
              "fa-neuter",
              "fa-genderless",
              "fa-facebook-official",
              "fa-pinterest-p",
              "fa-whatsapp",
              "fa-server",
              "fa-user-plus",
              "fa-user-times",
              "fa-hotel,before,.fa-bed",
              "fa-viacoin",
              "fa-train",
              "fa-subway",
              "fa-medium",
              "fa-yc,before,.fa-y-combinator",
              "fa-optin-monster",
              "fa-opencart",
              "fa-expeditedssl",
              "fa-battery-4,before,.fa-battery,before,.fa-battery-full",
              "fa-battery-3,before,.fa-battery-three-quarters",
              "fa-battery-2,before,.fa-battery-half",
              "fa-battery-1,before,.fa-battery-quarter",
              "fa-battery-0,before,.fa-battery-empty",
              "fa-mouse-pointer",
              "fa-i-cursor",
              "fa-object-group",
              "fa-object-ungroup",
              "fa-sticky-note",
              "fa-sticky-note-o",
              "fa-cc-jcb",
              "fa-cc-diners-club",
              "fa-clone",
              "fa-balance-scale",
              "fa-hourglass-o",
              "fa-hourglass-1,before,.fa-hourglass-start",
              "fa-hourglass-2,before,.fa-hourglass-half",
              "fa-hourglass-3,before,.fa-hourglass-end",
              "fa-hourglass",
              "fa-hand-grab-o,before,.fa-hand-rock-o",
              "fa-hand-stop-o,before,.fa-hand-paper-o",
              "fa-hand-scissors-o",
              "fa-hand-lizard-o",
              "fa-hand-spock-o",
              "fa-hand-pointer-o",
              "fa-hand-peace-o",
              "fa-trademark",
              "fa-registered",
              "fa-creative-commons",
              "fa-gg",
              "fa-gg-circle",
              "fa-tripadvisor",
              "fa-odnoklassniki",
              "fa-odnoklassniki-square",
              "fa-get-pocket",
              "fa-wikipedia-w",
              "fa-safari",
              "fa-chrome",
              "fa-firefox",
              "fa-opera",
              "fa-internet-explorer",
              "fa-tv,before,.fa-television",
              "fa-contao",
              "fa-500px",
              "fa-amazon",
              "fa-calendar-plus-o",
              "fa-calendar-minus-o",
              "fa-calendar-times-o",
              "fa-calendar-check-o",
              "fa-industry",
              "fa-map-pin",
              "fa-map-signs",
              "fa-map-o",
              "fa-map",
              "fa-commenting",
              "fa-commenting-o",
              "fa-houzz",
              "fa-vimeo",
              "fa-black-tie",
              "fa-fonticons",
              "fa-reddit-alien",
              "fa-edge",
              "fa-credit-card-alt",
              "fa-codiepie",
              "fa-modx",
              "fa-fort-awesome",
              "fa-usb",
              "fa-product-hunt",
              "fa-mixcloud",
              "fa-scribd",
              "fa-pause-circle",
              "fa-pause-circle-o",
              "fa-stop-circle",
              "fa-stop-circle-o",
              "fa-shopping-bag",
              "fa-shopping-basket",
              "fa-hashtag",
              "fa-bluetooth",
              "fa-bluetooth-b",
              "fa-percent",
              "fa-gitlab",
              "fa-wpbeginner",
              "fa-wpforms",
              "fa-envira",
              "fa-universal-access",
              "fa-wheelchair-alt",
              "fa-question-circle-o",
              "fa-blind",
              "fa-audio-description",
              "fa-volume-control-phone",
              "fa-braille",
              "fa-assistive-listening-systems",
              "fa-asl-interpreting,before,.fa-american-sign-language-interpreting",
              "fa-deafness,before,.fa-hard-of-hearing,before,.fa-deaf",
              "fa-glide",
              "fa-glide-g",
              "fa-signing,before,.fa-sign-language",
              "fa-low-vision",
              "fa-viadeo",
              "fa-viadeo-square",
              "fa-snapchat",
              "fa-snapchat-ghost",
              "fa-snapchat-square",
              "fa-pied-piper",
              "fa-first-order",
              "fa-yoast",
              "fa-themeisle",
              "fa-google-plus-circle,before,.fa-google-plus-official",
              "fa-fa,before,.fa-font-awesome",
              "fa-handshake-o",
              "fa-envelope-open",
              "fa-envelope-open-o",
              "fa-linode",
              "fa-address-book",
              "fa-address-book-o",
              "fa-vcard,before,.fa-address-card",
              "fa-vcard-o,before,.fa-address-card-o",
              "fa-user-circle",
              "fa-user-circle-o",
              "fa-user-o",
              "fa-id-badge",
              "fa-drivers-license,before,.fa-id-card",
              "fa-drivers-license-o,before,.fa-id-card-o",
              "fa-quora",
              "fa-free-code-camp",
              "fa-telegram",
              "fa-thermometer-4,before,.fa-thermometer,before,.fa-thermometer-full",
              "fa-thermometer-3,before,.fa-thermometer-three-quarters",
              "fa-thermometer-2,before,.fa-thermometer-half",
              "fa-thermometer-1,before,.fa-thermometer-quarter",
              "fa-thermometer-0,before,.fa-thermometer-empty",
              "fa-shower",
              "fa-bathtub,before,.fa-s15,before,.fa-bath",
              "fa-podcast",
              "fa-window-maximize",
              "fa-window-minimize",
              "fa-window-restore",
              "fa-times-rectangle,before,.fa-window-close",
              "fa-times-rectangle-o,before,.fa-window-close-o",
              "fa-bandcamp",
              "fa-grav",
              "fa-etsy",
              "fa-imdb",
              "fa-ravelry",
              "fa-eercast",
              "fa-microchip",
              "fa-snowflake-o",
              "fa-superpowers",
              "fa-wpexplorer",
              "fa-meetup"
            ]
            const supportedPayloadTypes = ['flow', 'global', 'str', 'num', 'bool', 'json', 'date'];
            const defaultPayloadType = "str";
            // Create a table of menu items
            var menuItemList = $("#node-input-menuItems-container").css('min-height','150px').css('min-width','500px').editableList({
                header: $("<div>").css({padding:"6px"}).append($.parseHTML(
                    "<div style='width:15%; margin-left:25px; display: inline-grid'><b>ID</b></div>" +
                    "<div style='width:15%; display: inline-grid'><b>Label</b></div>" +
                    "<div style='width:15%; display: inline-grid'><b>Icon</b></div>" +
                    "<div style='width:15%; display: inline-grid'><b>Topic</b></div>" +
                    "<div style='width:25%; display: inline-grid'><b>Payload</b></div>"
                    )),           
                addItem: function(container, i, menuItem) {
                    // When menuItem === {} then we have a new list item (i.e. user pressed the addItem button)
                    if (Object.keys(menuItem).length === 0) {
                        // Initialize new items in the list.
                        menuItem = {
                            id      : "", 
                            label   : "",
                            icon    : "",
                            topic   : "",
                            payload : "",
                            visible : true,
                            enabled : true
                        };
                    }
                        
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    $('<i style="color:#eee; cursor:move; margin-left:3px;" class="red-ui-editableList-item-handle fa fa-bars node-input-menuItem-handle"></i>').appendTo(row);
                     //Column 1 : Add an input field (type string) to the new row, that represents the command 
                     var idField = $('<input/>',{class:"node-input-menuItem-id",type:"text",placeholder:"id"}).css({"width":"15%","margin-left":"25px","margin-right":"5px"}).appendTo(row);
                     idField.val(menuItem.id);
                    // Column 2 : Add an input field (type string) to the new row, that represents the label 
                    var labelField = $('<input/>',{class:"node-input-menuItem-label",type:"text",placeholder:"label"}).css({"width":"15%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    labelField.val(menuItem.label);
                    
                    // Column 3 : Add an input field (type string) to the new row, that represents the icon (css class name) 
                    // TODO this has to become an autocomplete field ...
                    var iconField = $('<input/>',{class:"node-input-menuItem-icon",type:"text",placeholder:"fa-..."}).css({"width":"15%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    iconField.autocomplete({
                        source: iconCssClassNames
                    });
                    iconField.val(menuItem.icon);
                    // Column 4 : Add an input field (type string) to the new row, that represents the msg.topic content
                    var topicField = $('<input/>',{class:"node-input-menuItem-topic",type:"text",placeholder:"Topic"}).css({"width":"15%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    topicField.val(menuItem.topic);
                    // Column 5 : Add a input field (type string) to the new row, that represents the msg.payload content 
                    var payloadField = $('<input/>',{class:"node-input-menuItem-payload",type:"text",placeholder:"Payload"}).css({"width":"25%","margin-left":"5px"}).appendTo(row);
                                        
                    // hidden item (payloadType)
                    var payloadTypeField = $('<input/>',{class:"node-input-menuItem-payloadType",type:"hidden"}).appendTo(row);
                    var payloadType = supportedPayloadTypes.includes(menuItem.payloadType) ? menuItem.payloadType : defaultPayloadType;
                    payloadField.typedInput({
                        default: defaultPayloadType,
                        typeField: payloadTypeField,
                        types: supportedPayloadTypes
                    });
                    payloadField.typedInput("type", payloadType);              
                    payloadField.typedInput("value", menuItem.payload);   
                    //new line
                    var line2 = $('<div/>').css({"padding": "6px"}).appendTo(row);
                    // Line 2, Column 1
                    var visibleFieldId = "menuItemVisible" + i;
                    var visibleField = $('<input/>',{id: visibleFieldId, class:"node-input-menuItem-visible",type:"checkbox"}).css({"margin-left": "20px","margin-right": "5px", "vertical-align": "top", "width": "auto"}).appendTo(line2);
                    var visibleLabelField = $('<label/>',{for: visibleFieldId }).css({"margin-left": "0px", "vertical-align": "top"}).text("Visible").appendTo(line2);
                    visibleField.prop('checked', menuItem.visible);
                    // Line 2, Column 7  
                    var enabledFieldId = "menuItemEnabled" + i;
                    var enabledField = $('<input/>',{id: enabledFieldId, class:"node-input-menuItem-enabled",type:"checkbox"}).css({"margin-left": "0px","margin-right": "5px", "vertical-align": "top", "width": "auto"}).appendTo(line2);
                    var enabledLabelField = $('<label/>',{for: enabledFieldId }).css({"margin-left": "0px", "vertical-align": "top"}).text("Enabled").appendTo(line2);
                    enabledField.prop('checked', menuItem.enabled);
                },
                removable: true
            });
            // Show all the menu items (stored in this node) into the editableList
            if (this.menuItems) {
                this.menuItems.forEach(function (menuItem, index) {
                    menuItemList.editableList('addItem', {id:menuItem.id, icon:menuItem.icon, label:menuItem.label, topic:menuItem.topic, payload:menuItem.payload, payloadType:menuItem.payloadType, visible:menuItem.visible, enabled:menuItem.enabled});
                });
            }

            // Show the inputPositionXField and inputPositionYField value in a typedinput element (dropdown with 'msg' and 'num')
            $("#node-input-typed-inputPositionXField").typedInput({types:['msg', 'num']});
            $("#node-input-typed-inputPositionYField").typedInput({types:['msg', 'num']});

            // Migrate existing nodes (containing the old 'position' field), which have no typedinputs for the location yet
            switch (node.position) {
                case "fixed":
                    // Copy the obsolete x and y coordinates to the new typedinputs
                    $('#node-input-inputPositionXField').val(node.xCoordinate);
                    $('#node-input-inputPositionYField').val(node.yCoordinate);
                    
                    $("#node-input-typed-inputPositionXField").typedInput('type','num');
                    $("#node-input-typed-inputPositionYField").typedInput('type','num');
                    break;
                case "msg":
                    // Copy the obsolete msg.position field where the location was being expected to arrive in the past
                    $('#node-input-inputPositionXField').val("position.x");
                    $('#node-input-inputPositionYField').val("position.y");  
                    
                    $("#node-input-typed-inputPositionXField").typedInput('type','msg');
                    $("#node-input-typed-inputPositionYField").typedInput('type','msg');
                    break;
                default:
                    // Recent node, so no migration needed
                    $('#node-input-inputPositionXField').val(node.inputPositionXField);
                    $('#node-input-inputPositionYField').val(node.inputPositionYField);
                    
                    $("#node-input-typed-inputPositionXField").typedInput('type', node.inputPositionXType);
                    $("#node-input-typed-inputPositionYField").typedInput('type', node.inputPositionYType);
            }
            
            
            var xValue = $("#node-input-inputPositionXField").val() || '';
            var yValue = $("#node-input-inputPositionYField").val() || '';
            $("#node-input-typed-inputPositionXField").typedInput('value',xValue);
            $("#node-input-typed-inputPositionYField").typedInput('value',yValue);      
            
            // Show the inputMenuField value in a typedinput element (dropdown with 'msg' and a custom typedefinition)
            $("#node-input-typed-inputMenuField").typedInput({types:['msg', {
                // Custom typedefinition to represent a fixed menu
                value: 'fixed',
                label: 'Fixed layout',
                hasValue: false
            }]});
            
            // Only show the menu items table, when the menu is "fixed"
            $("#node-input-typed-inputMenuField").change(function(type, value) {
                if (value === "fixed") {
                    $(".contextmenu-menuitems-row").show();
                }
                else {
                    $(".contextmenu-menuitems-row").hide();
                }
            });
            
            // Migrate existing nodes (containing the old 'position' field), which have no typedinput for the menu yet
            switch (node.menu) {
                case "fixed":         
                    $("#node-input-typed-inputMenuField").typedInput('type','fixed');
                    break;
                case "msg":
                    // Copy the obsolete msg.menu field where the menu was being expected to arrive in the past
                    $('#node-input-inputMenuField').val("menu");          
                    $("#node-input-typed-inputMenuField").typedInput('type','msg');
                    break;                
                default:
                    // Recent node, so no migration needed
                    $('#node-input-inputMenuField').val(node.inputMenuField);
                    $("#node-input-typed-inputMenuField").typedInput('type', node.inputMenuType);
            }
            
            var value = $("#node-input-inputMenuField").val() || '';
            $("#node-input-typed-inputMenuField").typedInput('value',value);
            
            // Show the outputField value in a typedinput element (dropdown with only 'msg')
            var value = $("#node-input-outputField").val() || '';
            $("#node-input-typed-outputField").typedInput({types:['msg']});
            $("#node-input-typed-outputField").typedInput('type','msg');
            $("#node-input-typed-outputField").typedInput('value',value);

            $( "#node-input-menuItems-container" ).sortable({
                axis: "y",
                handle:".node-input-menuItem-handle",
                cursor: "move"
            });
            
            // Only show the colour fields, when the colours are "custom"
            $("#node-input-colors").change(function() {
                if ($("#node-input-colors").val() === "custom") {
                    $(".contextmenu-customColours").show();
                }
                else {
                    $(".contextmenu-customColours").hide();
                }
                updateEditorLayout();//update height of list etc
            });
            $("#node-input-colors").change();
        },
        oneditsave: function() {
            var node = this;
            
            // Remove (once) the obsolete position-related data
            delete node.position;
            delete node.xCoordinate;
            delete node.yCoordinate;
            
            // Copy the inputPositionXField value from the typedinput element to the inputPositionXField element
            // And copy the inputPositionXField type to this node.
            var value = $("#node-input-typed-inputPositionXField").typedInput('value');
            $("#node-input-inputPositionXField").val(value);
            node.inputPositionXType = $("#node-input-typed-inputPositionXField").typedInput('type');

            // Copy the inputPositionYField value from the typedinput element to the inputPositionYField element
            // And copy the inputPositionXField type to this node.
            value = $("#node-input-typed-inputPositionYField").typedInput('value');
            $("#node-input-inputPositionYField").val(value);  
            node.inputPositionYType = $("#node-input-typed-inputPositionYField").typedInput('type');     

            // Remove (once) the obsolete menu-related data
            delete node.menu;            

            // Copy the inputMenuField value from the typedinput element to the inputMenuField element
            value = $("#node-input-typed-inputMenuField").typedInput('value');
            $("#node-input-inputMenuField").val(value);
            node.inputMenuType = $("#node-input-typed-inputMenuField").typedInput('type');
            
            // Copy the outputField value from the typedinput element to the outputField element
            // No need to store the type, since there is only one option ('msg')
            value = $("#node-input-typed-outputField").typedInput('value');
            $("#node-input-outputField").val(value); 
            
            // Copy all the menu items from the editableList to this node
            node.menuItems = [];
            var menuItemsList = $("#node-input-menuItems-container").editableList('items');
            menuItemsList.each(function(i) {
                var menuItem = $(this);
                var o = {
                    id: menuItem.find(".node-input-menuItem-id").val(), 
                    icon: menuItem.find(".node-input-menuItem-icon").val(), 
                    label: menuItem.find(".node-input-menuItem-label").val(), 
                    topic: menuItem.find(".node-input-menuItem-topic").val(), 
                    payload: menuItem.find(".node-input-menuItem-payload").val(), 
                    payloadType: menuItem.find(".node-input-menuItem-payloadType").val(), 
                    visible: menuItem.find(".node-input-menuItem-visible").is(":checked"), 
                    enabled: menuItem.find(".node-input-menuItem-enabled").is(":checked")
                }                
                node.menuItems.push(o);
            });
        },
        oneditresize: function(){
            updateEditorLayout()
        }
    });
</script>

<script type="text/html" data-template-name="ui_context_menu">
   <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</span></label>
        <input type="text" id="node-input-group">
    </div>    
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-fontSize"><i class="fa fa-font"></i> Font size</label>
        <input id="node-input-fontSize" type="number" style="width: 60px">
        <span>px</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-typed-inputPositionXField"><i class="fa fa-list"></i> X coord.</label>
        <input id="node-input-typed-inputPositionXField" type="text" style="width: 70%">
        <input id="node-input-inputPositionXField" type="hidden">
    </div>
    
    <div class="form-row">
        <label for="node-input-typed-inputPositionYField"><i class="fa fa-list"></i> Y coord.</label>
        <input id="node-input-typed-inputPositionYField" type="text" style="width: 70%">
        <input id="node-input-inputPositionYField" type="hidden">
    </div>

    <div class="form-row">
        <label for="node-input-typed-outputField"><i class="fa fa-sign-out"></i> Output field</label>
        <input id="node-input-typed-outputField" type="text" style="width: 70%">
        <input id="node-input-outputField" type="hidden">
    </div>  

    <div class="form-row">
        <label for="node-input-typed-inputMenuField"><i class="fa fa-list"></i> Menu</label>
        <input id="node-input-typed-inputMenuField" type="text" style="width: 70%">
        <input id="node-input-inputMenuField" type="hidden">
    </div>    
  
    <div class="form-row form-row-auto-height contextmenu-menuitems-row">
        <!-- Table with menu items -->
        <ol id="node-input-menuItems-container"></ol>
    </div>
    
    </br>

    <div class="form-row">
        <label for="node-input-intervalLength"><i class="fa fa-clock-o"></i> Auto hide</label>
        <input type="number" id="node-input-intervalLength" style="width:180px;">
        <select id="node-input-intervalUnit" style="width:120px;">
            <option value="msecs">MilliSeconds</option>
            <option value="secs">Seconds</option>
            <option value="mins">Minutes</option>
        </select>
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-startTimerAtOpen" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-startTimerAtOpen" style="width:70%;"> Start timer when the contextmenu is displayed</label>
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-startTimerAtLeave" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-startTimerAtLeave" style="width:70%;"> Start timer when mouse leaves the contextmenu</label>
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-stopTimerAtEnter" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-stopTimerAtEnter" style="width:70%;"> Stop timer when mouse enters the contextmenu</label>
    </div>
    
    </br>
    
    <div class="form-row">
        <label for="node-input-colors"><i class="fa fa-cog"></i> Colours</label>
        <select id="node-input-colors">
            <option value="native">Default</option>
            <option value="custom">Custom</option> 
            <option value="theme">Match dashboard theme</option>
        </select>
    </div>
    
    <div class="form-row contextmenu-customColours">
        <label for="node-input-textColor"><i class="fa fa-paint-brush"></i> Text</span></label>
        <input type="color" id="node-input-textColor"/>
    </div>
    
    <div class="form-row contextmenu-customColours">
        <label for="node-input-backgroundColor"><i class="fa fa-paint-brush"></i> Background</span></label>
        <input type="color" id="node-input-backgroundColor"/>
    </div>    
    
    <div class="form-row contextmenu-customColours">
        <label for="node-input-borderColor"><i class="fa fa-paint-brush"></i> Hover</span></label>
        <input type="color" id="node-input-borderColor"/>
    </div>
</script>
<script type="text/html" data-help-name="ui_context_menu">
    <p>A Node Red node to show a popup context menu inside the dashboard.</p>
    <p><strong>CAUTION: The context menu will only appear when the group (see config screen) is currently visible!</strong></p>
    <h3>General Properties...</h3>
    <dl class="message-properties">
        <h4>Group</h4>
        <div style="padding-left: 15px">
            Where you want the SVG to be displayed on your dashboard.
        </div>
        <h4>Size</h4>
        <div style="padding-left: 15px">
            The size of the widget on the dashboard
        </div>    
        <h4>Name</h4>
        <div style="padding-left: 15px">
            The name of this node 
        </div>
        <h4>Font size</h4>
        <div style="padding-left: 15px">
            The font size of the menu items 
        </div>        
        <h4>X and Y coordinates</h4>
        <div style="padding-left: 15px">
            These coordinates (in pixels!) determine how the menu will be positioned:.
            <ul>
                <li>Message based, which means the <code>msg</code>must have the specified fields (containing the x and/or y coordinates).</li>
                <li>Fixed coordinate numbers.</li>
            </ul>
        </div>
        <h4>Output To</h4>
        <div style="padding-left: 15px">
            <code>Output to</code> permits you to specify what part of the <code>msg</code> to send the payload to. The default is <code>payload</code> This setting can be overridden on each menu item as required. See the example in "Message Based menu details" below.  
        </div>                
        <h4>Menu</h4>
        <div style="padding-left: 15px">
            The menu contents.
            <ul>
                <li>Message Based - when selected, <code>msg</code>must contain the specified message property, which needs to hold the menu items</li>
                <li>Fixed - when selected, enter the menu into list below</li>
            </ul>
            <p>Fixed menu options...</p>
            <p>
                <ul>
                    <li>ID - the id of the menu item</li>
                    <li>Label - what is displayed in the menu</li>
                    <li>Icon - the font-awesome icon to display</li>
                    <li>Topic - the <code>topic</code> to send in the output <code>msg</code></li>
                    <li>Payload - the <code>payload</code> to send in the output <code>msg</code></li>
                </ul>
            </p>
            <p><b>Message Based menu details...</b></p>
            <p> <code>msg.menu</code> should contain an object with items for the menu structure:<br>
<pre style="white-space: pre">
[
    {
        "text": "Options",
        "icon": "fa-list",
        "sub": [
            {
                "text": "Edit",
                "icon": "fa-edit",
                "topic": "edit",
                "payload": [ 1, 2, 3, 4, 5 ],
                "payloadType": "JSON",
                "outputField" : "editArray"
            },
            {
                "text": "Cut",
                "icon": "fa-cut",
                "enabled": true,
                "topic": "cut",
                "payload": "true",
                "payloadType": "bool"
            }
        ]
    },
    {
        "text": "---"
    },
    {
        "text": "Delete",
        "icon": "fa-trash",
        "enabled": true,
        "payload": "12",
        "payloadType": "num"
    },
    {
        "text": "---"
    },
    {
        "text": "Quit",
        "icon": "fa-times",
        "enabled": false
    }
] 
</pre>
            </p>
        </div>
        <h4>Auto hide</h4>
        <div style="padding-left: 15px">
            When this value is <code>0</code> the context menu will stay visible, until a menu item is selected or outside the menu is being clicked.  When this value is e.g. <code>3 seconds</code> this means that the context menu will automatically disappear when the context menu is out of focus during at least 3 seconds.  Via a series of checkboxes, you can specify when the timer needs to start and stop:
            <ul>
                <li>Start timer when the contextmenu is displayed.</li>
                <li>Start timer when mouse leaves the contextmenu.</li>
                <li>Stop timer when mouse enters the contextmenu.</li>
            </ul>
        </div>     
        <h4>Colors</h4>
        <div style="padding-left: 15px">
            This determines which colors will be used for the menu.
            <ul>
                <li>Default - The default menu colors will be used.</li>
                <li>Custom - Three color pickers will be displayed to specify custom colors.</li>
                <li>Match dashboard theme - The colors of the currently selected dashboard theme will be used.</li>
            </ul>
        </div>        
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt><i>payload</i> <span class="property-type">string|object|Array</span></dt>
        <dd style="display: none">
            It is possible to dynamically enable/disable or show.hide menu items - <b>TODO</b>   
        </dd>
        <dd>
            <ul>
                <li>If "Menu" option is set to "Message based", an object containing the menu structure must be present in <code>msg.menu</code>. See Message Based menu details above</li>
                <li>If "Position" option is set to "Message based", then object <code>msg.position</code> must be present and must contain <code>.x</code> and <code>.y</code> number properties</li>
                <li>Any message sent to the node will trigger it to open</li>
            </ul>            
        </dd>
    </dl>
        
    <h3>Output</h3>
    <dl class="message-properties">
        <dt><i>payload</i> <span class="property-type">number|string|boolean|object|buffer</span></dt>
        <dd><code>msg.payload*</code> will contain whatever is configured in 'payload'. payload may be changed by setting "Output To" </dd>
        <dd>if <code>payload</code> is not configured for the menu item, it will default to a string containing the label of clicked item</dd>
        <dt><i>topic</i> <span class="property-type">string</span></dt>
        <dd><code>msg.topic</code> will contain whatever is configured in 'topic'</dd>
        <dd>if <code>topic</code> is not configured for the menu item, it will default to a string containing the key of clicked item</dd>
        <dt><i>sourceMsg</i> <span class="property-type">object</span></dt>
        <dd><code>msg.sourceMsg</code> will contain the original input message, which has triggered the display of the context menu. </dd>
    </dl>

</script>
