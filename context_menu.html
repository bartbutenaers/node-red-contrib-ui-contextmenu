<!--
  Copyright 2019, Bart Butenaers, Stephen McLaughlin
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/javascript">
    RED.nodes.registerType('ui_context_menu',{
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {
                value: 0,
                validate: function(v) {
                    var valid = true
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()|| this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},
            height: {value: 0},
            position: {value: "fixed"},
            unit: {value: "perc"},
            xCoordinate: {value: 50},
            yCoordinate: {value: 50},
            menu: {value: "fixed"},
            menuItems: {value: []},
            name: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "menu.png",
        align: 'left',
        paletteLabel:"Context menu",
        label: function() {
            return this.name || "Context menu";
        },
        oneditprepare: function() {
            var node = this;
            
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            // Create a table of menu items
            var menuItemList = $("#node-input-menuItems-container").css('min-height','150px').css('min-width','450px').editableList({
                header: $("<div>").append($.parseHTML("<div style='width:30%; margin-left:5px; display: inline-grid'><b>Command</b></div><div style='width:15%; display: inline-grid'><b>Icon</b></div><div style='width:50%; display: inline-grid'><b>Label</b></div>")),
                addItem: function(container, i, menuItem) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    
                    // Column 1 : Add an input field (type string) to the new row, that represents the command 
                    var commandField = $('<input/>',{class:"node-input-menuItem-command",type:"text",placeholder:"command"}).css({"width":"30%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    commandField.val(menuItem.command);
                    
                    // Column 2 : Add an input field (type string) to the new row, that represents the icon (css class name) 
                    // TODO this has to become an autocomplete field ...
                    var iconField = $('<input/>',{class:"node-input-menuItem-icon",type:"text",placeholder:"fa-..."}).css({"width":"15%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    iconField.val(menuItem.icon);

                    // Column 3 : Add an input field (type string) to the new row, that represents the label 
                    var labelField = $('<input/>',{class:"node-input-menuItem-label",type:"text",placeholder:"label"}).css({"width":"50%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    labelField.val(menuItem.label);
                },
                removable: true
            });
            
            // Show all the menu items (stored in this node) into the editableList
            if (this.menuItems) {
                this.menuItems.forEach(function (menuItem, index) {
                    menuItemList.editableList('addItem', {targetId:menuItem.command, action:menuItem.icon, payload:menuItem.label});
                });
            }
        },
        oneditsave: function() {
            var node = this;
            
            // Copy all the menu items from the editableList to this node
            node.menuItems = [];
            var menuItemsList = $("#node-input-menuItems-container").editableList('items');
            menuItemsList.each(function(i) {
                var menuItem = $(this);
                var command = menuItem.find(".node-input-menuItem-command").val();
                var icon = menuItem.find(".node-input-menuItem-icon").val();
                var label  = menuItem.find(".node-input-menuItem-label").val();
                
                node.clickableShapes.push({command:command, icon:icon, label:label});
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="ui_context_menu">
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</span></label>
        <input type="text" id="node-input-group">
    </div>    
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> Size</span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    </br>
    <div class="form-row">
        <label for="node-input-unit"><i class="fa fa-envelope"></i> Units</label>
        <select id="node-input-unit">
            <option value="perc">Percentages</option> 
            <option value="pix">Pixels</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-position"><i class="fa fa-envelope"></i> Position</label>
        <select id="node-input-position">
            <option value="fixed">Fixed</option> 
            <option value="msg">Message based</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-xCoordinate"><i class="fa fa-list"></i> X coordinate</label>
        <input id="node-input-xCoordinate" type="number" style="width: 70%">
    </div>
    <div class="form-row">
        <label for="node-input-yCoordinate"><i class="fa fa-list"></i> Y coordinate</label>
        <input id="node-input-yCoordinate" type="number" style="width: 70%">
    </div>
    <div class="form-row">
        <label for="node-input-menu"><i class="fa fa-envelope"></i> Menu</label>
        <select id="node-input-menu">
            <option value="fixed">Fixed</option> 
            <option value="msg">Message based</option>
        </select>
    </div>
    <div class="form-row form-row-auto-height">
        <!-- Table with menu items -->
        <ol id="node-input-menuItems-container"></ol>
    </div>
</script>
<script type="text/x-red" data-help-name="ui_context_menu">
    <p>A Node Red node to show a popup context menu inside the dashboard.</p>
</script>